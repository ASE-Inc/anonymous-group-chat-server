<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Anonymous Group Chat: Based on NodeJS & websockets</title>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            onerror = function (msg) {
                log(msg);
            }
            function log(msg) {
                console.log(new Date() + ' ' + msg + '\n');
                document.getElementById('log').appendChild(document.createTextNode(new Date() + ' ' + msg + '\n'));
            }
            function clearLog() {
                var e = document.getElementById('log');
                while (e.hasChildNodes()) {
                    e.removeChild(e.firstChild);
                }
                e.appendChild(document.createTextNode('Log: \n'));
            }
            var socket = null, publicsocket = null;
            function connect() {
                log('Connecting to AGC server...');
                if (socket == null) {
                    socket = io.connect(document.location.href);
                    socket.on('connect', function () {
                        log('Connected');
                        document.getElementById('statusbar').className = 'Connected';
                        document.getElementById('status').textContent = 'Connected';
                    });
                    socket.on('message', function (data) {
                        log(data.name+": "+data.msg);
                    });
                }
                socket.socket.connect();
            }
            function send() {
                if (socket && socket.socket.connected) {
                    socket.emit("message",{
                        name:document.getElementById('nametext').value,
                        msg:document.getElementById('msgtext').value
                    });
                    if(document.getElementById('publiccheck').value=="checked") {
                        if(!publicsocket) publicsocket = io.connect(document.location.origin);
                        publicsocket.emit("message",{
                            name:document.getElementById('nametext').value,
                            msg:document.getElementById('msgtext').value
                        });
                    }
                    document.getElementById('msgtext').value="";
                    //log('>' + document.getElementById('text').value);
                } else {
                    log('Not connected.');
                }
                return false;
            }
            function update() {
                if (socket && socket.socket && socket.socket.transport) {
                    document.getElementById('sessionId').textContent = socket.socket.transport.sessid;
                    document.getElementById('transport').textContent = socket.socket.transport.name;
                } else {
                    document.getElementById('sessionId').textContent = '-';
                    document.getElementById('transport').textContent = '-';
                }
            }
            setInterval(update, 10);
        </script>
        <style>
            #title {
                text-align:center;
            }
            #statusbar {
                color: white;
            }
            #statusbar.Idle {
                background-color:grey;
            }
            #statusbar.Connected {
                background-color:green;
            }
            .sessionDetails {
            }
            #msgtext {
                width: 91%;
                min-height: 69px;
                display: block;
            }
        </style>
    </head>
    <body>
        <h1 id="title">Anonymous Group Chat</h1>
        <div id="statusbar" class="Idle"> Status: <span id="status">Idle</span></div>
        <div class="sessionDetails">SessionId: <span id="sessionId"> </span></div>
        <div class="sessionDetails">Transport: <span id="transport"> </span></div>
        <hr/>
        <form onsubmit="return false;">
            <label for="nametext">Name: <input id="nametext" type="text" size="80" value="" required/></label><hr/>
            <label for="msgtext">Message: <textarea id="msgtext" value="" placeholder="Message ..." required/></textarea>
            <label for="publiccheck">Public: <input id="publiccheck" type="checkbox" size="80" value="" required/></label><hr/>
            <input type="submit" value="Send" onclick="send()">
        </form>
        <input type=button value="Clear History" onclick="clearLog()"/>
        
        <pre id="log">Log:</pre>
        <footer>
            Create by: <a href="http://abhishekmunie.com">Abhishek Munie</a>
            Powered by: <a href="http://c9.io">Cloud9 IDE</a> & <a href="http://www.heroku.com/">Heroku (pronounced her-OH-koo)</a>
        </footer>
        <script>connect();</script>
    </body>
</html>